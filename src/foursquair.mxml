<?xml version="1.0" encoding="utf-8"?>
<mx:WindowedApplication xmlns:mx="http://www.adobe.com/2006/mxml" layout="absolute" width="350" initialize="init();">
    <mx:Script>
        <![CDATA[
            import mx.controls.Alert;
            import com.foursquare.api.*;
            import mx.collections.ArrayCollection;
            import mx.utils.ObjectUtil;
            import mx.effects.Blur;
            import mx.effects.Move;

            public var foursquare:FoursqaureService = new FoursqaureService('266d5934f6cb223fcd5ffc75eeb0a99404acf504c', '6265da6ce9bd8cb2c69632ae51836327');
            [Bindable] public var checkins:ArrayCollection;
            [Bindable] public var actor:UserVO;
            
            import flash.filesystem.*; 
            public var file:File; 
            
            private function init():void{
                file = File.applicationStorageDirectory; 
                file = file.resolvePath("Preferences/data_super_test_version.txt"); 
                if(file.exists) { 
                    var stream:FileStream = new FileStream(); 
	                stream.open(file, FileMode.READ); 
	                var filedata:String = stream.readUTFBytes(stream.bytesAvailable); 
	                stream.close();
	                var xml:XML = new XML(filedata);
	                foursquare.oauth_token = xml.descendants('oauth_token').toString();
                    foursquare.oauth_token_secret = xml.descendants('oauth_token_secret').toString();
	                bootstrap();
	                
                } else { 
                    firstRun(); 
                } 
            }
            
            private function firstRun():void { 
                // do stuff..
            } 
            
            public function showFlashMessage(msg:String):void{
                
            }
            
            public function checkForUpdates():void{
                foursquare.getCheckins(
                    function(c:Array){
                        var lastKnown:CheckinVO = checkins.getItemAt(0) as CheckinVO;
                        if(lastKnown.id < c[0].id){
                            
                        }
                    }
                );
            }
            
            private function handleTabBarItemClick(e:*):Boolean{
                return false;
            }
            
            public function transition(from:Canvas,to:Canvas,direction:String):void{
                var out:Move = new Move();
                var incoming:Move = new Move();
                if(direction=='right'){
                    out.duration = 500;
                    out.target = from;
                    out.xTo = -900;
                    to.visible = false;
                    incoming.target = to;
                    incoming.xTo = 900;
                    incoming.play();
                    incoming.end();
                    to.visible = true;
                    incoming.xTo = 0;
                    out.play();
                    incoming.play();
                }
                else {
                    out.duration = 500;
                    out.target = from;
                    out.xTo = 900;
                    to.visible = false;
                    incoming.target = to;
                    incoming.xTo = -900;
                    incoming.play();
                    incoming.end();
                    to.visible = true;
                    incoming.xTo = 0;
                    out.play();
                    incoming.play();
                }
                
                var out_blur:Blur = new Blur();
                out_blur.target = from;
                out_blur.duration = 500;
                out_blur.play();
                
                var incoming_blur:Blur = new Blur();
                incoming_blur.target = to;
                incoming_blur.duration = 500;
                incoming_blur.blurXTo = 0.0;
                incoming_blur.blurXFrom = 200.0;
                incoming_blur.play();
                
                /*
                setTimeout(
                    function():void{
                        if(to.id=='artist'){
                            main.selectedIndex = 1;
                        }
                        else if(to.id=='album'){
                            main.selectedIndex = 2;
                        }
                        else if(to.id=='song'){
                            main.selectedIndex = 3;
                        }
                        else if(to.id=='welcome'){
                            main.selectedIndex = 0;
                        }
                    },
                    500
                );
                */
            }
            
            public function bootstrap():void{
            	splash.visible = false;
                main.visible = true;
                       
            	foursquare.getUserDetails(
            	    0, 
            	    function(u:UserVO):void{
	                    actor = u;
	                    foursquare.actor = u;
	                    foursquare.getHistory(
	                        20,
	                        function(c:Array):void{
	                            checkins = new ArrayCollection(c);
	                        }
	                    );
	                }, 
	                null, 
	                true, 
	                false
                );
            }
            
            public function handleLogin():void{
            	foursquare.authExchange(
            	   username.text, 
            	   password.text, 
            	   function():void{
            	       //Store these in Sqlite?
            	       var c:XML = new XML('<foursquare><oauth_token>'+foursquare.oauth_token+'</oauth_token><oauth_token_secret>'+foursquare.oauth_token_secret+'</oauth_token_secret></foursquare>');
            	       var contents:String = c.toXMLString();
            	       
            	       var stream:FileStream = new FileStream(); 
		               stream.open(file, FileMode.WRITE);
		               stream.writeUTFBytes(contents); 
		               stream.close(); 
            	       //foursquare.oauth_token
            	       //foursquare.oauth_token_secret
            	       bootstrap();
            	   }, 
            	   function():void{
            	   	   
            	   }
            	);
            }
            
        ]]>
    </mx:Script>
    <mx:VBox id="splash">
        <mx:Form defaultButton="{loginSubmit}">
        <mx:Label text="Username or phone #" />
        <mx:TextInput id="username" />
        
        <mx:Label text="Password" />
        <mx:TextInput id="password"  displayAsPassword="true"/>
        
        <mx:Button label="Sign in" id="loginSubmit" click="handleLogin();"/>
        </mx:Form>
    </mx:VBox>
    
    <mx:HBox width="100%" height="100%" id="main" visible="false">
        <mx:VBox width="80" height="100%" horizontalAlign="center" id="sidebar" backgroundColor="#242424">
            	<mx:Image source="{actor.photo}" height="75" width="75"/>
            	<mx:TabBar dataProvider="viewstack1" width="100%" paddingLeft="0" direction="vertical" itemClick="handleTabBarItemClick(event);"></mx:TabBar>
        </mx:VBox>
        <mx:ViewStack id="viewstack1" width="100%" height="100%">
            <mx:Canvas label="F" width="100%" height="100%">
                <mx:VBox width="100%" height="100%">
                    <mx:Label text="Friends"  fontSize="11"/>
                    <mx:List dataProvider="{checkins}" width="100%" height="100%" backgroundColor="#D2D2D2" themeColor="#FFFFFF"><mx:itemRenderer>
                        <mx:Component>
                            <mx:HBox width="100%" horizontalScrollPolicy="off" verticalScrollPolicy="off">
                                <mx:Image source="{data.user.photo}" height="75" width="75" />
                                <mx:VBox verticalGap="0" width="100%" borderStyle="solid" cornerRadius="3" horizontalScrollPolicy="off" verticalScrollPolicy="off" backgroundColor="#FFFFFF" paddingLeft="5" paddingRight="5" paddingBottom="5" paddingTop="5">
                                    <mx:HBox width="100%">
                                    	<mx:Text text="{data.user.firstname} {data.user.lastname.substr(0,1)}." width="100%" fontSize="11" fontWeight="bold" />
                                    	<mx:Text text="{data.created_in_words}" fontSize="9" />
                                    </mx:HBox>
                                    <mx:Text text="@ {data.venue.name}" width="100%" fontWeight="bold" fontSize="10" />
                                    <mx:Text text="&quot;{data.shout}&quot;" includeInLayout="{data.shout!=''}" visible="{data.shout!=''}" width="100%" fontSize="10" />
                                </mx:VBox>
                            </mx:HBox>
                        </mx:Component>
                    </mx:itemRenderer></mx:List>
                </mx:VBox>
            </mx:Canvas>
            <mx:Canvas label="B" width="100%" height="100%">
                <mx:VBox width="100%" height="100%">
                    <mx:Label text="Your badges" />
                    <mx:List dataProvider="{actor.badges}" width="100%" height="100%"><mx:itemRenderer>
                        <mx:Component>
                            <mx:HBox width="100%" horizontalScrollPolicy="off" verticalScrollPolicy="off">
                                <mx:Image source="{data.icon}" height="57" width="57" />
                                <mx:VBox width="100%" horizontalScrollPolicy="off" verticalScrollPolicy="off">
                                    <mx:Text text="{data.name}" width="100%" />
                                    <mx:Text text="{data.description}" width="100%"></mx:Text>
                                </mx:VBox>
                            </mx:HBox>
                        </mx:Component>
                    </mx:itemRenderer></mx:List>
                </mx:VBox>
            </mx:Canvas>
        </mx:ViewStack>
        <!--
        <mx:HBox width="100%" horizontalGap="0">
            <mx:Button label="Shout"  width="100%"/>
            <mx:Button label="Add Friends"  width="100%"/>
            <mx:Button label="Add Venue"  width="100%"/>
            <mx:Button label="Help"  width="100%"/>
        </mx:HBox>
        -->
        <!--
        <mx:HBox width="100%">
            <mx:Label text="Shout" />
            <mx:TextInput id="shoutText"  width="100%"/>
            <mx:Button label="Holler" />
        </mx:HBox>
        -->
    </mx:HBox>
</mx:WindowedApplication>